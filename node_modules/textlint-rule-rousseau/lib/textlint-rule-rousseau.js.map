{"version":3,"sources":["../src/textlint-rule-rousseau.js"],"names":[],"mappings":"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","file":"textlint-rule-rousseau.js","sourcesContent":["// LICENSE : MIT\n\"use strict\";\nimport {RuleHelper, IgnoreNodeManager} from \"textlint-rule-helper\";\nconst StringSource = require(\"textlint-util-to-string\").default;\nconst rousseau = require(\"rousseau\");\nconst map = require(\"unist-util-map\");\nconst ObjectAssign = require(\"object-assign\");\nconst defaultOptions = {\n    // \"suggestion\", \"warning\", \"error\"\n    showLevels: [\"suggestion\", \"warning\", \"error\"],\n    // ignore check type of https://github.com/GitbookIO/rousseau#checks\n    ignoreTypes: [],\n    // ignore textlint's node type\n    ignoreInlineNodeTypes: [\"Code\"]\n};\n\nconst mapNode = function (ast, mapFn) {\n    return (function preorder(node, index, parent) {\n        const newNode = ObjectAssign({}, mapFn(node, index, parent));\n        if (node.children) {\n            newNode.children = node.children.map(function (child, index) {\n                return preorder(child, index, node);\n            });\n        }\n        return newNode;\n    }(ast, null, null));\n};\n\nexport default function textlintRousseau(context, options = defaultOptions) {\n    const helper = new RuleHelper(context);\n    const ignoreNodeManager = new IgnoreNodeManager();\n    const {Syntax, RuleError, report, getSource} = context;\n    const showLevels = options.showLevels || defaultOptions.showLevels;\n    const ignoreTypes = options.ignoreTypes || defaultOptions.ignoreTypes;\n    const ignoreInlineNodeTypes = options.ignoreInlineNodeTypes || [Syntax.Code];\n    const isShowType = (type)=> {\n        return ignoreTypes.indexOf(type) === -1;\n    };\n    const isShowLevel = (level) => {\n        return showLevels.indexOf(level) !== -1;\n    };\n    /*\n     {\n     // Type of check that output this suggestion\n     type: \"so\",\n\n     // Level of importance\n     // \"suggestion\", \"warning\", \"error\"\n     level: \"warning\",\n\n     // Index in the text\n     index: 10,\n\n     // Size of the section in the text\n     offset: 2,\n\n     // Message to describe the suggestion\n     message: \"omit 'So' from the beginning of sentences\",\n\n     // Replacements suggestion\n     replacements: [\n     {\n     value: \"\"\n     }\n     ]\n     }\n     */\n    const createSuggest = (replacements) => {\n        if (replacements.length === 0) {\n            return \"\";\n        }\n        return \"\\nSuggestions:\\n\"\n            + replacements.map(({value}) => {\n                return \"=> \" + value;\n            }).join(\"\\n\");\n    };\n    const reportError = (node, source, result) => {\n        const level = result.level;\n        const type = result.type;\n        // if not contains showing options, ignore this result\n        if (!isShowLevel(level)) {\n            return;\n        }\n        if (!isShowType(type)) {\n            return;\n        }\n        const index = source.originalIndexFromIndex(result.index);\n        // if already ignored, should not report\n        if (ignoreNodeManager.isIgnoredIndex(index)) {\n            return;\n        }\n        const suggestions = createSuggest(result.replacements);\n        const ruleError = new RuleError(`${level}(${type}) ${result.message}${suggestions}`, {\n            index\n        });\n        report(node, ruleError);\n    };\n\n    return {\n        [Syntax.Paragraph](node){\n            // ignore if wrapped node types\n            if (helper.isChildNode(node, [Syntax.Link, Syntax.Image, Syntax.BlockQuote, Syntax.Emphasis])) {\n                return;\n            }\n            // ignore if contain child node types\n            ignoreNodeManager.ignoreChildrenByTypes(node, ignoreInlineNodeTypes);\n            // check\n            // replace code with dummy code\n            // if you want to filter(remove) code, use https://github.com/eush77/unist-util-filter\n            const filteredNode = map(node, (node) => {\n                if (node.type === Syntax.Code) {\n                    // only change `value` to dummy\n                    return ObjectAssign({}, node, {\n                        value: new Array(node.value.length + 1).join(\"x\")\n                    });\n                }\n                return node;\n            });\n            if (!filteredNode) {\n                return;\n            }\n            const source = new StringSource(filteredNode);\n            const text = source.toString();\n            const reportSourceError = (results) => {\n                reportError(node, source, results);\n            };\n            rousseau(text, function (err, results) {\n                if (err) {\n                    throw err;\n                }\n                results.forEach(reportSourceError);\n            });\n        }\n    }\n}"]}